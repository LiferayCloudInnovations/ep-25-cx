#!/usr/bin/env bash

set -ex

for cx in "$1"/*.zip
do
    # Unzip the client extension
    cx_name=$(basename "$cx" .zip)
    unzip -d "$cx_name" "$cx"

    # Build and push the Docker image to registry
    cd "$cx_name"
    docker build -t "$cx_name":latest .
    docker tag "$cx_name":latest localhost:5000/"$cx_name":latest
    docker push localhost:5000/"$cx_name":latest

    # Deploy the client extension to the Kubernetes cluster
    helm upgrade --install "$cx_name" \
        --namespace liferay-system \
        -f cx-values.yaml \
        ../helm-charts/client-extension/

    cd ..
    rm -rf "$cx_name"
done
