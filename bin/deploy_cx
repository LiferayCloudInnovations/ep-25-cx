#!/usr/bin/env bash

set -ex

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
git_root="$(git -C "$script_dir" rev-parse --show-toplevel)"

for cx in "$1"/*.zip
do
    # Unzip the client extension
    cx_name=$(basename "$cx" .zip)
    rm -rf "${git_root}/tmp/cx_build/$cx_name"
    mkdir -p "${git_root}/tmp/cx_build/$cx_name"
    unzip -d "${git_root}/tmp/cx_build/$cx_name" "$cx"

    # Build and push the Docker image to registry
    cd "${git_root}/tmp/cx_build/$cx_name"
    docker build -t "$cx_name":latest .
    docker tag "$cx_name":latest localhost:5000/"$cx_name":latest
    docker push localhost:5000/"$cx_name":latest

    # Deploy the client extension to the Kubernetes cluster
    helm upgrade --install "$cx_name"-cx \
        --namespace liferay-system \
        -f cx-values.yaml \
        ../../../helm-charts/client-extension/
done
