#!/usr/bin/env bash

set -ex

for cx in "$1"/*.zip
do
    # Unzip the client extension
    cx_name=$(basename "$cx" .zip)
    rm -rf "tmp/cx_build/$cx_name"
    mkdir -p "tmp/cx_build/$cx_name"
    unzip -d "tmp/cx_build/$cx_name" "$cx"

    # Build and push the Docker image to registry
    cd "tmp/cx_build/$cx_name"
    docker build -t "$cx_name":latest .
    docker tag "$cx_name":latest localhost:5000/"$cx_name":latest
    docker push localhost:5000/"$cx_name":latest

    # Deploy the client extension to the Kubernetes cluster
    helm upgrade --install "$cx_name"-cx \
        --namespace liferay-system \
        -f cx-values.yaml \
        ../../../helm-charts/client-extension/
done
